<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tipray.dao.AppdevDao">
    <resultMap id="fullResultMap" type="com.tipray.bean.AppDev">
        <id column="id" property="id"/>
        <result column="uuid" property="uuid"/>
        <result column="app_id" property="appid"/>
        <result column="system" property="system"/>
        <result column="model" property="model"/>
        <result column="current_webapp_version" property="currentVer"/>
        <result column="name" property="owner"/>
        <result column="phone" property="phone"/>
        <result column="duty" property="duty"/>
        <result column="institution" property="institution"/>
    </resultMap>

    <sql id="select_colums">
        a.id,
    	a.uuid,
    	a.app_id,
        a.system,
        a.model,
        a.current_webapp_version,
        a.name,
        a.phone,
        a.duty,
        a.institution
    </sql>

    <select id="findAll" resultMap="fullResultMap">
        SELECT
        <include refid="select_colums"></include>
        FROM
        tbl_webapp_device a
    </select>

    <insert id="add" useGeneratedKeys="true" keyProperty="id" parameterType="com.tipray.bean.AppVer">
		INSERT INTO tbl_webapp_device(uuid, app_id, system, model, current_webapp_version, `name`, phone, duty, institution)
		VALUES
			(
				#{uuid},
				#{appid},
				#{system},
				IFNULL(#{model}, ""),
				#{currentVer},
				IFNULL(#{owner}, ""),
				IFNULL(#{phone}, ""),
				IFNULL(#{duty}, ""),
				IFNULL(#{institution}, "")
			)
	</insert>

    <update id="update" parameterType="com.tipray.bean.AppDev">
        update tbl_webapp_device set
            system                  = #{system},
            model                   = #{model},
            current_webapp_version  = #{currentVer},
            `name`                  = #{owner},
            phone                   = #{phone},
            duty                    = #{duty},
            institution             = #{institution}
        where id                    = #{id}
    </update>

    <update id="updateModelAndCurrentVerByUuidAndAppid">
		update tbl_webapp_device set
		    model                   = #{model},
			current_webapp_version	= #{currentVer}
		where uuid 			        = #{uuid}
		and   app_id                = #{appid}
	</update>

    <update id="delete" parameterType="java.lang.Long">
		delete from tbl_webapp_device where id = #{id}
	</update>

    <select id="getById" parameterType="java.lang.Long" resultMap="fullResultMap">
        SELECT
        <include refid="select_colums"></include>
        FROM tbl_webapp_device a
        WHERE
         a.id = #{id}
    </select>

    <select id="getByUuidAndAppid" parameterType="java.lang.String" resultMap="fullResultMap">
        SELECT
        <include refid="select_colums"></include>
        FROM
        tbl_webapp_device a
        WHERE
         a.uuid = #{uuid}
        and a.app_id = #{appid}
    </select>

    <select id="countByUuidAndAppid" parameterType="java.lang.String" resultType="java.lang.Integer">
        select count(id) from tbl_webapp_device where uuid = #{uuid} and app_id = #{appid}
    </select>

    <select id="findIdsByUuidAndAppid" parameterType="java.lang.String" resultType="java.lang.Long">
        select id from tbl_webapp_device where uuid = #{uuid} and app_id = #{appid}
    </select>

    <delete id="deleteByUuidAndAppid" parameterType="java.lang.String">
        delete from tbl_webapp_device where uuid = #{uuid} and app_id = #{appid}
    </delete>

    <select id="count" parameterType="com.tipray.bean.AppDev" resultType="java.lang.Long">
        select count(*) from tbl_webapp_device where 1 = 1
        <if test="uuid != null and uuid !=''">
            and uuid like CONCAT('%',#{uuid},'%')
        </if>
        <if test="owner != null and owner != ''">
            and `name` like CONCAT('%',#{owner},'%')
        </if>
    </select>

    <select id="findByPage" resultMap="fullResultMap">
        SELECT
        <include refid="select_colums"></include>
        FROM
        tbl_webapp_device a
        WHERE 1 = 1
        <if test="entity.uuid != null and entity.uuid !=''">
            and a.uuid like CONCAT('%',#{entity.uuid},'%')
        </if>
        <if test="entity.owner != null and entity.owner != ''">
            and a.`name` like CONCAT('%',#{entity.owner},'%')
        </if>
        order by a.gmt_create desc, a.id desc
        limit #{page.startRow}, #{page.rows}
    </select>

    <select id="getCenterIdById" parameterType="java.lang.Long" resultType="java.lang.Long">
        select center_id from tbl_webapp_device where id = #{id};
    </select>

    <select id="getCenterAddrById" parameterType="java.lang.Long" resultType="com.tipray.bean.Center">
        select inet_ntoa(c.ip) ip, c.web_port webPort
        from tbl_center c, tbl_webapp_device a
        where a.center_id = c.id and a.id = #{id}
    </select>

    <select id="findByCenterId" parameterType="java.lang.Long" resultType="com.tipray.bean.AppDev">
        SELECT
            a.id,
            a.uuid,
            a.app_id appid,
            a.system,
            a.model,
            a.current_webapp_version currentVer,
            a.`name` `owner`,
            a.phone,
            a.duty,
            a.institution,
            a.gmt_create createDate,
            a.gmt_modified modifyDate
        FROM
            tbl_webapp_device a,
            tbl_center_device d
        WHERE
            a.uuid = d.uuid
            AND a.app_id = d.app_id
            AND d.center_id = #{centerId}
    </select>

    <insert id="addAppCenter">
        insert into tbl_center_device (center_id, uuid, app_id) values
        <foreach collection="centerIds" item="centerId" separator=",">
            (#{centerId}, #{uuid}, #{appid})
        </foreach>
    </insert>

    <delete id="deleteAppCenter">
        delete from tbl_center_device where uuid = #{uuid} and app_id = #{appid} and center_id in
        <foreach collection="centerIds" item="centerId" open="(" close=")" separator=",">
            #{centerId}
        </foreach>
    </delete>

    <delete id="deleteAppCenterByAppdevId" parameterType="java.lang.Long">
        DELETE d
        FROM
            tbl_center_device d,
            tbl_webapp_device a
        WHERE
            d.uuid = a.uuid
            AND d.app_id = a.app_id
            AND a.id = #{appdevId}
        <!--
        DELETE
        FROM
            tbl_center_device
        WHERE
            id = (
                SELECT
                    t.id
                FROM
                    (
                    SELECT
                        d.id
                    FROM
                        tbl_center_device d,
                        tbl_webapp_device a
                    WHERE
                        d.uuid = a.uuid
                        AND d.app_id = a.app_id
                        AND a.id = 15
                    ) t
            )
        -->
    </delete>

    <select id="findCenterIdsByAppdevId" parameterType="java.lang.Long" resultType="java.lang.Long">
        select
            d.center_id
        from
            tbl_webapp_device a,
            tbl_center_device d
        where
            a.uuid = d.uuid
            and a.app_id = d.app_id
            and a.id = #{appdevId}
    </select>

    <select id="findCenterNamesByAppdevId" parameterType="java.lang.Long" resultType="java.lang.String">
        select
            c.`name`
        from
            tbl_webapp_device a,
            tbl_center_device d,
            tbl_center c
        where
            a.uuid = d.uuid
            and a.app_id = d.app_id
            and c.id = d.center_id
            and a.id = #{appdevId}
        ORDER BY c.id
    </select>

    <select id="findBelongCentersByAppdevId" parameterType="java.lang.Long" resultType="com.tipray.bean.Center">
         select
            c.id,
            c.`name`
        from
            tbl_webapp_device a,
            tbl_center_device d,
            tbl_center c
        where
            a.uuid = d.uuid
            and a.app_id = d.app_id
            and c.id = d.center_id
            and a.id = #{appdevId}
        ORDER BY c.id
    </select>

    <select id="findAppCentersByAppdevId" parameterType="java.lang.Long" resultType="com.tipray.bean.AppCenter">
        SELECT
            c.id,
            c.`name`,
            t.uuid checked
        FROM
            tbl_center c
            LEFT JOIN (
                SELECT
                    d.center_id,
                    a.uuid
                FROM
                    tbl_webapp_device a,
                    tbl_center_device d
                WHERE
                    a.uuid = d.uuid
                    and a.app_id = d.app_id
                    AND a.id = #{appdevId}
            ) t ON c.id = t.center_id
        WHERE c.id > 0
        ORDER BY c.id
    </select>

    <select id="findCenterIdsByUuidAndAppid" parameterType="java.lang.Long" resultType="java.lang.Long">
        select center_id from tbl_center_device where uuid = #{uuid} and app_id = #{appid}
    </select>

    <select id="findCentersByUuid" parameterType="java.lang.String" resultType="com.tipray.bean.Center">
        select c.id, c.`name` from tbl_center_device d, tbl_center c where c.id = d.center_id and d.uuid = #{uuid}
    </select>

    <select id="findUuidsByCenterId" parameterType="java.lang.Long" resultType="java.lang.String">
        select uuid from tbl_center_device where center_id = #{centerId};
    </select>

    <select id="getCenterWebAddr" parameterType="java.lang.Long" resultType="com.tipray.bean.AppInfo">
        select id center_id, name center_name, inet_ntoa(ip) ip, web_port port from tbl_center where id = #{centerId}
    </select>
</mapper>